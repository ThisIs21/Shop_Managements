{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.every.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport { ref, computed, onMounted } from \"vue\";\nimport GudangLayouts from \"@/components/GudangLayouts.vue\";\nimport axios from \"axios\";\n\n// --- Variabel State ---\n\nexport default {\n  __name: 'DashboardGudang',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const showModal = ref(false);\n    const stockOpnames = ref([]); // Menyimpan Header SO dari backend\n    const loading = ref(false);\n    const products = ref([]); // Menyimpan detail produk (termasuk unit, kategori)\n    const opnameForm = ref({\n      date: new Date().toISOString().split(\"T\")[0],\n      note: \"\",\n      items: [{\n        product_id: null,\n        qty_fisik: 0\n      }]\n    });\n    const submitting = ref(false);\n    const errorMessage = ref(\"\");\n    const summary = ref({\n      totalOpnames: 0\n    });\n\n    // --- Konfigurasi API ---\n    const api = axios.create({\n      baseURL: \"http://localhost:8081/api/v1\"\n    });\n    const savedToken = localStorage.getItem(\"token\");\n    if (savedToken) {\n      api.defaults.headers.common[\"Authorization\"] = `Bearer ${savedToken}`;\n    } else {\n      errorMessage.value = \"Authentication token not found. Please log in.\";\n    }\n    const currentDate = computed(() => new Date().toISOString().split(\"T\")[0]);\n    const isFormValid = computed(() => {\n      return opnameForm.value.items.every(item => item.product_id && item.qty_fisik >= 0 && item.qty_fisik !== null);\n    });\n\n    // ðŸš€ FIX: Mengambil detail produk dari data opname yang sudah di-preload,\n    //        bukan dari list products.value yang terpisah.\n    const flatOpnameItems = computed(() => {\n      // Hanya gunakan productMap sebagai fallback/data pelengkap\n      const productMap = products.value.reduce((map, p) => {\n        map[p.id] = p;\n        return map;\n      }, {});\n      const flattened = [];\n      stockOpnames.value.forEach(opname => {\n        // Pastikan Items ada. Item dari backend harusnya bernama 'Items' atau 'items'\n        const items = opname.Items || opname.items || [];\n        items.forEach((item, index) => {\n          // Ambil detail Produk yang sudah di-preload dari Item\n          const product = item.Product || item.product || {};\n\n          // Gunakan ID Produk untuk fallback lookup jika product kosong\n          const productId = product.ID || product.id || item.ProductID || item.product_id;\n          const productFallback = productMap[productId] || {};\n\n          // Qty Fisik dan Sistem (sesuaikan penamaan field GORM, biasanya CamelCase)\n          const qtyPhysical = item.QtyPhysical || item.qty_fisik || 0;\n          const qtySystem = item.QtySystem || item.qty_sistem || 0;\n          const delta = qtyPhysical - qtySystem;\n\n          // Dapatkan Nama Produk dan Unit dari data Preload atau Fallback\n          const productName = product.Name || product.name || productFallback.name || \"Unknown Product\";\n          const productUnit = product.Unit?.Name || product.unit?.name || productFallback.unit || \"N/A\";\n          flattened.push({\n            key: `${opname.ID}-${productId}-${index}`,\n            Date: opname.Date,\n            // Asumsi User/StaffName di-preload di opname.User.Name\n            StaffName: opname.User?.Name || opname.user?.name || \"Unknown\",\n            ProductName: productName,\n            ProductUnit: productUnit,\n            QtySystem: qtySystem,\n            QtyPhysical: qtyPhysical,\n            Delta: delta\n          });\n        });\n      });\n      // Hanya tampilkan 5 item detail terbaru (berdasarkan urutan fetch SO)\n      return flattened.slice(0, 5);\n    });\n    // --- Fungsi Data Fetching Ringkasan ---\n    const fetchStockOpnameSummary = async () => {\n      try {\n        const response = await api.get(\"/history/stock-opnames\", {\n          params: {\n            size: 1\n          }\n        });\n        const total = response.data.total !== undefined ? response.data.total : response.data.data?.total !== undefined ? response.data.data.total : 0;\n        summary.value.totalOpnames = total;\n      } catch (error) {\n        console.error(\"Gagal fetch ringkasan opnames:\", error);\n      }\n    };\n\n    // --- Fungsi Data Fetching Riwayat Terbaru (Ambil Header SO) ---\n    const fetchStockOpnames = async () => {\n      loading.value = true;\n      errorMessage.value = \"\";\n      try {\n        // Ambil 5 Header SO terbaru. Items harus disertakan (eager loading)\n        const response = await api.get(\"//stock-opnames\", {\n          // Ganti ke endpoint ListStockOpnames Anda\n          params: {\n            limit: 5\n          } // Gunakan limit seperti di Go service\n        });\n\n        // Sesuaikan cara membaca data. Biasanya ListStockOpnames mengembalikan array langsung\n        const dataContainer = response.data.data || [];\n        stockOpnames.value = (dataContainer || []).map(op => {\n          return {\n            ID: op.ID || op.id,\n            Date: op.Date || op.date,\n            // Data Items harus lengkap dengan Product, Unit, dan Category\n            Items: op.Items || op.items || [],\n            // Asumsi User/Staff Name\n            User: op.User || op.user\n          };\n        });\n      } catch (error) {\n        console.error(\"Gagal fetch stock opnames:\", error);\n        errorMessage.value = `Gagal memuat riwayat opname: ${error.response?.status} - ${error.response?.data?.error || \"Terjadi kesalahan pada server.\"}`;\n      } finally {\n        loading.value = false;\n      }\n    };\n\n    // FIX: fetchProducts tetap berjalan untuk mengisi dropdown form.\n    const fetchProducts = async () => {\n      try {\n        const response = await api.get(\"/products\");\n        // Asumsi: Backend mengembalikan data produk dengan Category dan Unit di-*preload*\n        products.value = (response.data.data || []).map(p => ({\n          id: p.ID || p.id,\n          name: p.Name || p.name,\n          // Akses relasi Category dan Unit dari object Product untuk form/fallback\n          unit: p.Unit?.Name || p.unit?.name || \"N/A\",\n          category: p.Category?.Name || p.category?.name || \"N/A\"\n        }));\n      } catch (error) {\n        console.error(\"Gagal fetch products:\", error);\n        // Jika gagal, pastikan array products tetap kosong, tapi proses tetap berjalan\n      }\n    };\n\n    // --- Fungsi Item Form ---\n    const addItem = () => {\n      opnameForm.value.items.push({\n        product_id: null,\n        qty_fisik: 0\n      });\n    };\n    const removeItem = index => {\n      if (opnameForm.value.items.length > 1) {\n        opnameForm.value.items.splice(index, 1);\n      }\n    };\n\n    // --- Fungsi Submit ---\n    const submitOpname = async () => {\n      if (!isFormValid.value) {\n        errorMessage.value = \"Harap isi semua kolom produk dan kuantitas fisik yang valid.\";\n        return;\n      }\n      submitting.value = true;\n      errorMessage.value = \"\";\n      try {\n        const payload = {\n          date: opnameForm.value.date,\n          note: opnameForm.value.note,\n          items: opnameForm.value.items.filter(item => item.product_id && item.qty_fisik >= 0)\n        };\n        const response = await api.post(\"/gudang/stock-opnames\", payload);\n        if (response.status === 201) {\n          alert(\"Stock opname berhasil dibuat dan stok telah disesuaikan!\");\n          opnameForm.value = {\n            date: new Date().toISOString().split(\"T\")[0],\n            note: \"\",\n            items: [{\n              product_id: null,\n              qty_fisik: 0\n            }]\n          };\n          showModal.value = false;\n          fetchStockOpnameSummary();\n          fetchStockOpnames();\n          // Tidak perlu fetchProducts lagi\n        }\n      } catch (error) {\n        console.error(\"Gagal submit opname:\", error);\n        // Menangkap error parsing date yang sering terjadi\n        if (error.response?.status === 400 && error.response?.data?.error.includes(\"parsing time\")) {\n          errorMessage.value = \"Gagal membuat stock opname: Format tanggal tidak didukung oleh server. Coba periksa konfigurasi date/time di server atau pastikan Anda menggunakan format YYYY-MM-DD.\";\n        } else {\n          errorMessage.value = `Gagal membuat stock opname: ${error.response?.status} - ${error.response?.data?.error || \"Terjadi kesalahan pada server.\"}`;\n        }\n      } finally {\n        submitting.value = false;\n      }\n    };\n    const formatDate = dateStr => {\n      if (!dateStr) return \"N/A\";\n      // Ganti Date() dengan cara yang lebih aman untuk format tanggal dari API (ISO 8601)\n      const date = new Date(dateStr.split(\"T\")[0]); // Ambil hanya tanggalnya\n\n      if (isNaN(date)) return dateStr; // Fallback jika parsing gagal\n\n      return date.toLocaleDateString(\"id-ID\", {\n        day: \"2-digit\",\n        month: \"2-digit\",\n        year: \"numeric\"\n      });\n    };\n\n    // --- Lifecycle Hook ---\n    onMounted(() => {\n      fetchStockOpnameSummary();\n      fetchStockOpnames();\n      fetchProducts(); // Harus di-fetch pertama untuk detail produk dropdown\n    });\n    const __returned__ = {\n      showModal,\n      stockOpnames,\n      loading,\n      products,\n      opnameForm,\n      submitting,\n      errorMessage,\n      summary,\n      api,\n      savedToken,\n      currentDate,\n      isFormValid,\n      flatOpnameItems,\n      fetchStockOpnameSummary,\n      fetchStockOpnames,\n      fetchProducts,\n      addItem,\n      removeItem,\n      submitOpname,\n      formatDate,\n      ref,\n      computed,\n      onMounted,\n      GudangLayouts,\n      get axios() {\n        return axios;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","computed","onMounted","GudangLayouts","axios","showModal","stockOpnames","loading","products","opnameForm","date","Date","toISOString","split","note","items","product_id","qty_fisik","submitting","errorMessage","summary","totalOpnames","api","create","baseURL","savedToken","localStorage","getItem","defaults","headers","common","value","currentDate","isFormValid","every","item","flatOpnameItems","productMap","reduce","map","p","id","flattened","forEach","opname","Items","index","product","Product","productId","ID","ProductID","productFallback","qtyPhysical","QtyPhysical","qtySystem","QtySystem","qty_sistem","delta","productName","Name","name","productUnit","Unit","unit","push","key","StaffName","User","user","ProductName","ProductUnit","Delta","slice","fetchStockOpnameSummary","response","get","params","size","total","data","undefined","error","console","fetchStockOpnames","limit","dataContainer","op","status","fetchProducts","category","Category","addItem","removeItem","length","splice","submitOpname","payload","filter","post","alert","includes","formatDate","dateStr","isNaN","toLocaleDateString","day","month","year"],"sources":["C:/Users/Personal/Documents/PKL/aplikasi/aplikasi/src/views/DashboardGudang.vue"],"sourcesContent":["<template>\n  <GudangLayouts>\n    <div class=\"space-y-6\">\n      <div>\n        <h1 class=\"text-3xl font-bold text-gray-900\">\n          Warehouse Staff Dashboard\n        </h1>\n        <p class=\"text-lg text-gray-600 mt-1\">\n          Welcome back! Here's an overview of your warehouse activities.\n        </p>\n      </div>\n\n      <div class=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6\">\n        <div\n          class=\"bg-white rounded-xl shadow-lg p-6 border border-blue-100 hover:shadow-xl transition-shadow\"\n        >\n          <p class=\"text-sm font-medium text-blue-600\">Total Stock Opname</p>\n          <div class=\"mt-1 flex items-center justify-between\">\n            <p class=\"text-3xl font-bold text-gray-900\">\n              {{ summary.totalOpnames || 0 }}\n            </p>\n            <svg\n              class=\"w-8 h-8 text-blue-400\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n            >\n              <path\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n                stroke-width=\"2\"\n                d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"\n              ></path>\n            </svg>\n          </div>\n          <p class=\"text-xs text-gray-500 mt-2\">Data tercatat sejak awal.</p>\n        </div>\n      </div>\n      <div class=\"flex justify-end\">\n        <button\n          @click=\"showModal = true\"\n          class=\"px-5 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition-colors\"\n        >\n          + Add New Opname\n        </button>\n      </div>\n\n      <div class=\"bg-white rounded-xl shadow-lg p-6 border border-gray-100\">\n        <div class=\"flex justify-between items-center mb-4 border-b pb-3\">\n          <h2 class=\"text-xl font-semibold text-gray-800\">\n            Riwayat Item Stock Opname Terbaru\n          </h2>\n          <router-link\n            to=\"/history/stock-opnames\"\n            class=\"px-4 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors\"\n          >\n            Lihat Semua Riwayat\n          </router-link>\n        </div>\n\n        <div class=\"overflow-x-auto\">\n          <table class=\"min-w-full divide-y divide-gray-200\">\n            <thead class=\"bg-gray-50\">\n              <tr>\n                <th\n                  class=\"px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Date\n                </th>\n                <th\n                  class=\"px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Product (Unit)\n                </th>\n                <th\n                  class=\"px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Qty Sistem\n                </th>\n                <th\n                  class=\"px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Qty Fisik\n                </th>\n                <th\n                  class=\"px-4 py-2 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Selisih\n                </th>\n                <th\n                  class=\"px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\"\n                >\n                  Staff\n                </th>\n              </tr>\n            </thead>\n            <tbody class=\"bg-white divide-y divide-gray-100\">\n              <tr v-if=\"loading\">\n                <td\n                  colspan=\"6\"\n                  class=\"px-4 py-4 text-center text-sm text-gray-500\"\n                >\n                  Loading...\n                </td>\n              </tr>\n              <tr v-else-if=\"flatOpnameItems.length === 0\">\n                <td\n                  colspan=\"6\"\n                  class=\"px-4 py-4 text-center text-sm text-gray-500\"\n                >\n                  No data available.\n                </td>\n              </tr>\n              <tr\n                v-else\n                v-for=\"item in flatOpnameItems\"\n                :key=\"item.key\"\n                class=\"hover:bg-gray-50 transition-colors\"\n              >\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700\">\n                  {{ formatDate(item.Date) }}\n                </td>\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700\">\n                  {{ item.ProductName }} ({{ item.ProductUnit || \"Unit\" }})\n                </td>\n                <td\n                  class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-center\"\n                >\n                  {{ item.QtySystem }}\n                </td>\n                <td\n                  class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-center\"\n                >\n                  {{ item.QtyPhysical }}\n                </td>\n                <td\n                  class=\"px-4 py-3 whitespace-nowrap text-sm font-medium text-center\"\n                  :class=\"{\n                    'text-red-600': item.Delta < 0,\n                    'text-green-600': item.Delta > 0,\n                    'text-gray-700': item.Delta === 0,\n                  }\"\n                >\n                  {{ item.Delta > 0 ? \"+\" : \"\" }}{{ item.Delta }}\n                </td>\n                <td class=\"px-4 py-3 whitespace-nowrap text-sm text-gray-700\">\n                  {{ item.StaffName || \"Unknown\" }}\n                </td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n        <p\n          v-if=\"errorMessage && !loading\"\n          class=\"text-red-500 text-sm mt-4 p-3 bg-red-50 rounded-lg border border-red-200\"\n        >\n          **Error:** {{ errorMessage }}\n        </p>\n      </div>\n    </div>\n\n    <div\n      v-if=\"showModal\"\n      class=\"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 flex justify-center items-center\"\n      @click.self=\"showModal = false\"\n    >\n      <div\n        class=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative transform transition-all\"\n        @click.stop\n      >\n        <h3 class=\"text-2xl font-bold text-gray-800 mb-4 border-b pb-2\">\n          Create New Stock Opname\n        </h3>\n        <button\n          @click=\"showModal = false\"\n          class=\"absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-3xl leading-none\"\n        >\n          &times;\n        </button>\n\n        <form\n          @submit.prevent=\"submitOpname\"\n          class=\"space-y-4 max-h-[70vh] overflow-y-auto pr-2\"\n        >\n          <div class=\"grid grid-cols-2 gap-4\">\n            <div>\n              <label class=\"block text-sm font-medium text-gray-700 mb-1\"\n                >Date</label\n              >\n              <input\n                v-model=\"opnameForm.date\"\n                type=\"date\"\n                required\n                class=\"block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500\"\n                :min=\"currentDate\"\n              />\n            </div>\n            <div>\n              <label class=\"block text-sm font-medium text-gray-700 mb-1\"\n                >Note (Optional)</label\n              >\n              <textarea\n                v-model=\"opnameForm.note\"\n                class=\"block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500\"\n                rows=\"3\"\n                placeholder=\"Enter any notes...\"\n              ></textarea>\n            </div>\n          </div>\n\n          <div class=\"border p-3 rounded-lg bg-gray-50\">\n            <label class=\"block text-base font-semibold text-gray-800 mb-3\"\n              >Opname Items</label\n            >\n            <div\n              v-for=\"(item, index) in opnameForm.items\"\n              :key=\"index\"\n              class=\"flex space-x-2 mb-3 items-center\"\n            >\n              <select\n                v-model=\"item.product_id\"\n                required\n                class=\"w-2/3 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2\"\n              >\n                <option value=\"\" disabled>Select Product</option>\n                <option\n                  v-for=\"product in products\"\n                  :key=\"product.id\"\n                  :value=\"product.id\"\n                >\n                  {{ product.name }}\n                </option>\n              </select>\n              <input\n                v-model.number=\"item.qty_fisik\"\n                type=\"number\"\n                min=\"0\"\n                required\n                class=\"w-1/4 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm py-2 text-center\"\n                placeholder=\"Qty Fisik\"\n              />\n              <button\n                @click.prevent=\"removeItem(index)\"\n                type=\"button\"\n                :disabled=\"opnameForm.items.length === 1\"\n                class=\"text-red-500 hover:text-red-700 text-xl disabled:opacity-30 disabled:cursor-not-allowed\"\n                title=\"Remove Item\"\n              >\n                &times;\n              </button>\n            </div>\n            <button\n              @click.prevent=\"addItem\"\n              type=\"button\"\n              class=\"mt-2 px-3 py-1.5 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors\"\n            >\n              + Add Item\n            </button>\n          </div>\n\n          <div class=\"flex justify-end pt-3\">\n            <button\n              type=\"button\"\n              @click=\"showModal = false\"\n              class=\"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 mr-3\"\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              :disabled=\"submitting || !isFormValid\"\n              class=\"px-6 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 transition-colors\"\n            >\n              {{ submitting ? \"Submitting...\" : \"Submit Opname\" }}\n            </button>\n          </div>\n\n          <p v-if=\"errorMessage\" class=\"text-red-500 text-sm pt-2\">\n            {{ errorMessage }}\n          </p>\n        </form>\n      </div>\n    </div>\n  </GudangLayouts>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted } from \"vue\";\nimport GudangLayouts from \"@/components/GudangLayouts.vue\";\nimport axios from \"axios\";\n\n// --- Variabel State ---\nconst showModal = ref(false);\nconst stockOpnames = ref([]); // Menyimpan Header SO dari backend\nconst loading = ref(false);\nconst products = ref([]); // Menyimpan detail produk (termasuk unit, kategori)\nconst opnameForm = ref({\n  date: new Date().toISOString().split(\"T\")[0],\n  note: \"\",\n  items: [{ product_id: null, qty_fisik: 0 }],\n});\nconst submitting = ref(false);\nconst errorMessage = ref(\"\");\nconst summary = ref({ totalOpnames: 0 });\n\n// --- Konfigurasi API ---\nconst api = axios.create({ baseURL: \"http://localhost:8081/api/v1\" });\nconst savedToken = localStorage.getItem(\"token\");\nif (savedToken) {\n  api.defaults.headers.common[\"Authorization\"] = `Bearer ${savedToken}`;\n} else {\n  errorMessage.value = \"Authentication token not found. Please log in.\";\n}\n\nconst currentDate = computed(() => new Date().toISOString().split(\"T\")[0]);\nconst isFormValid = computed(() => {\n  return opnameForm.value.items.every(\n    (item) => item.product_id && item.qty_fisik >= 0 && item.qty_fisik !== null\n  );\n});\n\n// ðŸš€ FIX: Mengambil detail produk dari data opname yang sudah di-preload,\n//        bukan dari list products.value yang terpisah.\nconst flatOpnameItems = computed(() => {\n  // Hanya gunakan productMap sebagai fallback/data pelengkap\n  const productMap = products.value.reduce((map, p) => {\n    map[p.id] = p;\n    return map;\n  }, {});\n\n  const flattened = [];\n  stockOpnames.value.forEach((opname) => {\n    // Pastikan Items ada. Item dari backend harusnya bernama 'Items' atau 'items'\n    const items = opname.Items || opname.items || [];\n\n    items.forEach((item, index) => {\n      // Ambil detail Produk yang sudah di-preload dari Item\n      const product = item.Product || item.product || {};\n\n      // Gunakan ID Produk untuk fallback lookup jika product kosong\n      const productId =\n        product.ID || product.id || item.ProductID || item.product_id;\n      const productFallback = productMap[productId] || {};\n\n      // Qty Fisik dan Sistem (sesuaikan penamaan field GORM, biasanya CamelCase)\n      const qtyPhysical = item.QtyPhysical || item.qty_fisik || 0;\n      const qtySystem = item.QtySystem || item.qty_sistem || 0;\n      const delta = qtyPhysical - qtySystem;\n\n      // Dapatkan Nama Produk dan Unit dari data Preload atau Fallback\n      const productName =\n        product.Name ||\n        product.name ||\n        productFallback.name ||\n        \"Unknown Product\";\n      const productUnit =\n        product.Unit?.Name ||\n        product.unit?.name ||\n        productFallback.unit ||\n        \"N/A\";\n\n      flattened.push({\n        key: `${opname.ID}-${productId}-${index}`,\n        Date: opname.Date,\n        // Asumsi User/StaffName di-preload di opname.User.Name\n        StaffName: opname.User?.Name || opname.user?.name || \"Unknown\",\n\n        ProductName: productName,\n        ProductUnit: productUnit,\n\n        QtySystem: qtySystem,\n        QtyPhysical: qtyPhysical,\n        Delta: delta,\n      });\n    });\n  });\n  // Hanya tampilkan 5 item detail terbaru (berdasarkan urutan fetch SO)\n  return flattened.slice(0, 5);\n});\n// --- Fungsi Data Fetching Ringkasan ---\nconst fetchStockOpnameSummary = async () => {\n  try {\n    const response = await api.get(\"/history/stock-opnames\", {\n      params: { size: 1 },\n    });\n    const total =\n      response.data.total !== undefined\n        ? response.data.total\n        : response.data.data?.total !== undefined\n        ? response.data.data.total\n        : 0;\n    summary.value.totalOpnames = total;\n  } catch (error) {\n    console.error(\"Gagal fetch ringkasan opnames:\", error);\n  }\n};\n\n// --- Fungsi Data Fetching Riwayat Terbaru (Ambil Header SO) ---\nconst fetchStockOpnames = async () => {\n  loading.value = true;\n  errorMessage.value = \"\";\n  try {\n    // Ambil 5 Header SO terbaru. Items harus disertakan (eager loading)\n    const response = await api.get(\"//stock-opnames\", {\n      // Ganti ke endpoint ListStockOpnames Anda\n      params: { limit: 5 }, // Gunakan limit seperti di Go service\n    });\n\n    // Sesuaikan cara membaca data. Biasanya ListStockOpnames mengembalikan array langsung\n    const dataContainer = response.data.data || [];\n\n    stockOpnames.value = (dataContainer || []).map((op) => {\n      return {\n        ID: op.ID || op.id,\n        Date: op.Date || op.date,\n        // Data Items harus lengkap dengan Product, Unit, dan Category\n        Items: op.Items || op.items || [],\n        // Asumsi User/Staff Name\n        User: op.User || op.user,\n      };\n    });\n  } catch (error) {\n    console.error(\"Gagal fetch stock opnames:\", error);\n    errorMessage.value = `Gagal memuat riwayat opname: ${\n      error.response?.status\n    } - ${error.response?.data?.error || \"Terjadi kesalahan pada server.\"}`;\n  } finally {\n    loading.value = false;\n  }\n};\n\n// FIX: fetchProducts tetap berjalan untuk mengisi dropdown form.\nconst fetchProducts = async () => {\n  try {\n    const response = await api.get(\"/products\");\n    // Asumsi: Backend mengembalikan data produk dengan Category dan Unit di-*preload*\n    products.value = (response.data.data || []).map((p) => ({\n      id: p.ID || p.id,\n      name: p.Name || p.name,\n      // Akses relasi Category dan Unit dari object Product untuk form/fallback\n      unit: p.Unit?.Name || p.unit?.name || \"N/A\",\n      category: p.Category?.Name || p.category?.name || \"N/A\",\n    }));\n  } catch (error) {\n    console.error(\"Gagal fetch products:\", error);\n    // Jika gagal, pastikan array products tetap kosong, tapi proses tetap berjalan\n  }\n};\n\n// --- Fungsi Item Form ---\nconst addItem = () => {\n  opnameForm.value.items.push({ product_id: null, qty_fisik: 0 });\n};\n\nconst removeItem = (index) => {\n  if (opnameForm.value.items.length > 1) {\n    opnameForm.value.items.splice(index, 1);\n  }\n};\n\n// --- Fungsi Submit ---\nconst submitOpname = async () => {\n  if (!isFormValid.value) {\n    errorMessage.value =\n      \"Harap isi semua kolom produk dan kuantitas fisik yang valid.\";\n    return;\n  }\n\n  submitting.value = true;\n  errorMessage.value = \"\";\n  try {\n    const payload = {\n      date: opnameForm.value.date,\n      note: opnameForm.value.note,\n      items: opnameForm.value.items.filter(\n        (item) => item.product_id && item.qty_fisik >= 0\n      ),\n    };\n\n    const response = await api.post(\"/gudang/stock-opnames\", payload);\n\n    if (response.status === 201) {\n      alert(\"Stock opname berhasil dibuat dan stok telah disesuaikan!\");\n\n      opnameForm.value = {\n        date: new Date().toISOString().split(\"T\")[0],\n        note: \"\",\n        items: [{ product_id: null, qty_fisik: 0 }],\n      };\n      showModal.value = false;\n      fetchStockOpnameSummary();\n      fetchStockOpnames();\n      // Tidak perlu fetchProducts lagi\n    }\n  } catch (error) {\n    console.error(\"Gagal submit opname:\", error);\n    // Menangkap error parsing date yang sering terjadi\n    if (\n      error.response?.status === 400 &&\n      error.response?.data?.error.includes(\"parsing time\")\n    ) {\n      errorMessage.value =\n        \"Gagal membuat stock opname: Format tanggal tidak didukung oleh server. Coba periksa konfigurasi date/time di server atau pastikan Anda menggunakan format YYYY-MM-DD.\";\n    } else {\n      errorMessage.value = `Gagal membuat stock opname: ${\n        error.response?.status\n      } - ${error.response?.data?.error || \"Terjadi kesalahan pada server.\"}`;\n    }\n  } finally {\n    submitting.value = false;\n  }\n};\n\nconst formatDate = (dateStr) => {\n  if (!dateStr) return \"N/A\";\n  // Ganti Date() dengan cara yang lebih aman untuk format tanggal dari API (ISO 8601)\n  const date = new Date(dateStr.split(\"T\")[0]); // Ambil hanya tanggalnya\n\n  if (isNaN(date)) return dateStr; // Fallback jika parsing gagal\n\n  return date.toLocaleDateString(\"id-ID\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  });\n};\n\n// --- Lifecycle Hook ---\nonMounted(() => {\n  fetchStockOpnameSummary();\n  fetchStockOpnames();\n  fetchProducts(); // Harus di-fetch pertama untuk detail produk dropdown\n});\n</script>\n\n<style scoped>\n/* Gaya Scrollbar */\n.max-h-\\[70vh\\]::-webkit-scrollbar {\n  width: 8px;\n}\n.max-h-\\[70vh\\]::-webkit-scrollbar-thumb {\n  background-color: #cbd5e1; /* gray-300 */\n  border-radius: 4px;\n}\n.max-h-\\[70vh\\]::-webkit-scrollbar-track {\n  background: #f1f1f1;\n}\n</style>\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}